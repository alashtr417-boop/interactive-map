<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø®Ø±ÙŠØ·Ø© ØªÙØ§Ø¹Ù„ÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø©</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
body { margin:0; font-family: "Segoe UI", Arial; }
#map { height:100vh; width:100%; }

#uploadBox {
  position: absolute;
  top: 15px;
  left: 15px;
  z-index: 9999;
  background: white;
  padding: 10px 14px;
  border-radius: 10px;
  box-shadow: 0 0 8px #0003;
  font-size: 14px;
}
#uploadBox label {
  font-weight: bold;
  color: #0066cc;
  cursor: pointer;
}
#uploadBox label:hover {
  text-decoration: underline;
}
</style>
</head>
<body>

<div id="uploadBox">
  <label>ğŸ“ Ø±ÙØ¹ Ù…Ù„Ù GeoJSON / Shapefile / GeoPackage
    <input type="file" id="fileInput" multiple style="display:none">
  </label>
</div>

<div id="map"></div>

<!-- Ù…ÙƒØªØ¨Ø§Øª -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/shapefile@0.6.6/dist/shapefile.js"></script>
<script src="https://unpkg.com/geopackage/dist/geopackage.min.js"></script>

<script>
// 1ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ø¹ Google Satellite
var googleSat = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { attribution: "Google Satellite" });
var map = L.map('map', { center: [33.3152,44.3661], zoom: 10, layers: [googleSat] });

var currentLayer = null;

// 2ï¸âƒ£ Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© GeoJSON Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ø±ØªÙØ§Ø¹ Z
function addGeoJSON(data) {
    if(currentLayer) map.removeLayer(currentLayer);

    currentLayer = L.geoJSON(data, {
        style: function(feature) {
            return {
                color: feature.properties.color || "#ffcc00",
                fillColor: feature.properties.fill || feature.properties.color || "#ffcc00",
                weight: 2,
                fillOpacity: 0.4
            }
        },
        onEachFeature: function(feature, layer) {
            // Ø¹Ø±Ø¶ Ø®ØµØ§Ø¦Øµ Feature
            let popup = "<div style='text-align:right'><h4>ØªÙØ§ØµÙŠÙ„</h4><table border='1' style='width:100%; border-collapse:collapse'>";
            for (let key in feature.properties) {
                popup += `<tr><td style='padding:4px; background:#f0f0f0'><b>${key}</b></td><td style='padding:4px'>${feature.properties[key]}</td></tr>`;
            }
            popup += "</table></div>";
            layer.bindPopup(popup);

            // Ø¯Ø¹Ù… Ø´Ø¨Ù‡ 3D: Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø§Ø±ØªÙØ§Ø¹
            if(feature.properties.height) {
                layer.setStyle({ fillOpacity: 0.6 });
            }
        }
    }).addTo(map);

    map.fitBounds(currentLayer.getBounds());
}

// 3ï¸âƒ£ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²
document.getElementById("fileInput").addEventListener("change", async function(e) {
    let files = e.target.files;

    let shpFile = Array.from(files).find(f => f.name.endsWith(".shp"));
    let dbfFile = Array.from(files).find(f => f.name.endsWith(".dbf"));
    let gpkgFile = Array.from(files).find(f => f.name.endsWith(".gpkg"));
    let geojsonFile = Array.from(files).find(f => f.name.endsWith(".geojson") || f.name.endsWith(".json"));

    try {
        if(shpFile && dbfFile){
            // ØªØ­ÙˆÙŠÙ„ Shapefile Ø¥Ù„Ù‰ GeoJSON
            let geojson = await shapefile.open(shpFile, dbfFile)
                .then(source => source.read().then(result => result.value));
            addGeoJSON(geojson);

        } else if(gpkgFile) {
            // Ù‚Ø±Ø§Ø¡Ø© GeoPackage
            const arrayBuffer = await gpkgFile.arrayBuffer();
            const geoPackage = await window.GeoPackage.GeoPackageAPI.open(arrayBuffer);
            const featureTables = geoPackage.getFeatureTables();
            if(featureTables.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ø¨Ù‚Ø§Øª ÙÙŠ GPKG");
            const features = await geoPackage.getGeoJSON(featureTables[0]);
            addGeoJSON(features);

        } else if(geojsonFile) {
            // Ù‚Ø±Ø§Ø¡Ø© GeoJSON Ù…Ø¨Ø§Ø´Ø±Ø©
            const reader = new FileReader();
            reader.onload = function(ev){
                try {
                    let json = JSON.parse(ev.target.result);
                    addGeoJSON(json);
                } catch(err){
                    alert("âŒ Ø§Ù„Ù…Ù„Ù Ù„ÙŠØ³ GeoJSON ØµØ§Ù„Ø­");
                }
            };
            reader.readAsText(geojsonFile);

        } else {
            alert("ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù GeoJSONØŒ Shapefile (.shp + .dbf)ØŒ Ø£Ùˆ GeoPackage (.gpkg)");
        }
    } catch(err){
        console.error(err);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù");
    }
});

// 4ï¸âƒ£ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
fetch("data/test11.geojson")
.then(res => res.ok ? res.json() : null)
.then(json => { if(json) addGeoJSON(json); })
.catch(err => console.log("Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§ÙØªØ±Ø§Ø¶ÙŠØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ù…Ù„Ù ÙŠØ¯ÙˆÙŠØ§Ù‹."));

</script>
</body>
</html>
