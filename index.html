<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø®Ø±ÙŠØ·Ø© ØªÙØ§Ø¹Ù„ÙŠØ© - Ù‚Ø§Ø±Ø¦ Shapefile Ø§Ù„Ù…ØµØ­Ø­</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
body { margin:0; font-family: "Segoe UI", Arial; }
#map { height:100vh; width:100%; }

#uploadBox {
  position: absolute;
  top: 15px;
  left: 15px;
  z-index: 9999;
  background: white;
  padding: 10px 14px;
  border-radius: 10px;
  box-shadow: 0 0 8px #0003;
  font-size: 14px;
}
#uploadBox label {
  font-weight: bold;
  color: #0066cc;
  cursor: pointer;
}
#uploadBox label:hover {
  text-decoration: underline;
}
#status {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
    display: none;
}
</style>
</head>
<body>

<div id="uploadBox">
  <label>ğŸ“ Ø±ÙØ¹ Ù…Ù„Ù (Shapefile ÙŠØ¬Ø¨ Ø±ÙØ¹ .shp Ùˆ .dbf Ù…Ø¹Ø§Ù‹)
    <input type="file" id="fileInput" multiple style="display:none">
  </label>
  <div id="status">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/shapefile@0.6.6/dist/shapefile.js"></script> 

<script>
// 1ï¸âƒ£ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
var googleSat = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { attribution: "Google Satellite" });
var map = L.map('map', { center: [33.3152,44.3661], zoom: 6, layers: [googleSat] });

var currentLayer = null;

// 2ï¸âƒ£ Ø¯Ø§Ù„Ø© Ø±Ø³Ù… GeoJSON
function addGeoJSON(data) {
    if(currentLayer) map.removeLayer(currentLayer);

    currentLayer = L.geoJSON(data, {
        style: function(feature) {
            return {
                color: feature.properties.color || "#ff5500",
                fillColor: feature.properties.fill || "#ff5500",
                weight: 2,
                fillOpacity: 0.4
            }
        },
        onEachFeature: function(feature, layer) {
            let popup = "<div style='text-align:right; max-height:200px; overflow-y:auto'><h4>ØªÙØ§ØµÙŠÙ„</h4><table border='1' style='width:100%; border-collapse:collapse'>";
            for (let key in feature.properties) {
                popup += `<tr><td style='padding:4px; background:#f0f0f0'><b>${key}</b></td><td style='padding:4px'>${feature.properties[key]}</td></tr>`;
            }
            popup += "</table></div>";
            layer.bindPopup(popup);
        }
    }).addTo(map);

    try {
        map.fitBounds(currentLayer.getBounds());
    } catch(e) { console.log("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¯ÙˆØ¯ Ù„Ù„Ø·Ø¨Ù‚Ø©"); }
    
    document.getElementById("status").style.display = "none";
}

// 3ï¸âƒ£ Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ ArrayBuffer (Ø¶Ø±ÙˆØ±ÙŠ Ù„Ù…Ù„ÙØ§Øª Shapefile)
function readFileAsArrayBuffer(file) {
    return new Promise((resolve, reject) => {
        let reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(reader.error);
        reader.readAsArrayBuffer(file);
    });
}

// 4ï¸âƒ£ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©
document.getElementById("fileInput").addEventListener("change", async function(e) {
    let files = e.target.files;
    let statusDiv = document.getElementById("status");
    statusDiv.style.display = "block";
    statusDiv.innerText = "Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØ§Øª...";

    // ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª
    let shpFile = Array.from(files).find(f => f.name.toLowerCase().endsWith(".shp"));
    let dbfFile = Array.from(files).find(f => f.name.toLowerCase().endsWith(".dbf"));
    let geojsonFile = Array.from(files).find(f => f.name.toLowerCase().endsWith(".geojson") || f.name.toLowerCase().endsWith(".json"));

    try {
        // âœ… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Shapefile (SHP + DBF)
        if(shpFile) {
            statusDiv.innerText = "Ø¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„ Shapefile...";
            
            // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØ§Øª ÙƒÙ€ ArrayBuffer
            const shpBuffer = await readFileAsArrayBuffer(shpFile);
            const dbfBuffer = dbfFile ? await readFileAsArrayBuffer(dbfFile) : undefined;

            // ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø©
            const source = await shapefile.open(shpBuffer, dbfBuffer);
            
            // ØªØ¬Ù…ÙŠØ¹ ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± (Loop) - Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø°ÙŠ ÙƒØ§Ù† ÙŠÙ†Ù‚ØµÙƒ
            let features = [];
            let result;
            while (!(result = await source.read()).done) {
                features.push(result.value);
            }

            // ØªÙƒÙˆÙŠÙ† ÙƒØ§Ø¦Ù† GeoJSON ÙƒØ§Ù…Ù„
            const geojson = {
                type: "FeatureCollection",
                features: features
            };

            addGeoJSON(geojson);

        } 
        // âœ… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: GeoJSON
        else if(geojsonFile) {
            const reader = new FileReader();
            reader.onload = function(ev){
                try {
                    let json = JSON.parse(ev.target.result);
                    addGeoJSON(json);
                } catch(err){
                    alert("âŒ Ø§Ù„Ù…Ù„Ù ØªØ§Ù„Ù");
                    statusDiv.style.display = "none";
                }
            };
            reader.readAsText(geojsonFile);
        } 
        else {
            alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù .shp (ÙŠÙØ¶Ù„ Ù…Ø¹Ù‡ .dbf) Ø£Ùˆ Ù…Ù„Ù .geojson");
            statusDiv.style.display = "none";
        }
    } catch(err){
        console.error(err);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + err.message);
        statusDiv.style.display = "none";
    }
});
</script>
</body>
</html>